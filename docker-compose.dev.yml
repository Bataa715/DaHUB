services:
  # ─── ClickHouse ──────────────────────────────────────────────────────────────
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    restart: unless-stopped

  # ─── Backend (NestJS — hot reload) ──────────────────────────────────────────
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.dev
    container_name: audit-backend-dev
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}
      - CORS_ORIGINS=${FRONTEND_URL:-http://localhost:9002}
      - CLICKHOUSE_HOST=http://clickhouse:8123
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE:-audit_db}
      # File watching on Windows/Docker
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
    volumes:
      # Mount source — changes reload automatically
      - ./apps/backend/src:/app/src
      - ./apps/backend/scripts:/app/scripts
      - ./apps/backend/nest-cli.json:/app/nest-cli.json
      - ./apps/backend/tsconfig.json:/app/tsconfig.json
      # Keep node_modules inside container (not from Windows host)
      - backend_modules:/app/node_modules
    depends_on:
      - clickhouse
    restart: unless-stopped

  # ─── Frontend (Next.js — hot reload) ────────────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: audit-frontend-dev
    ports:
      - "9002:9002"
    environment:
      - NODE_ENV=development
      # Browser calls backend — must be reachable from the browser
      - NEXT_PUBLIC_API_URL=${BACKEND_URL:-http://localhost:3001}
      # File watching on Windows/Docker
      - WATCHPACK_POLLING=true
    volumes:
      # Mount source — changes reload automatically
      - ./apps/nextn/src:/app/apps/nextn/src
      - ./apps/nextn/public:/app/apps/nextn/public
      # Keep node_modules inside container (not from Windows host)
      - frontend_modules:/app/node_modules
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  clickhouse-data:
  backend_modules:
  frontend_modules:
